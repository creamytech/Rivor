// prisma schema for rivor core models

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id          String       @id @default(cuid())
  email       String       @unique
  name        String?
  image       String?
  timezone    String       @default("America/New_York")
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  orgMembers  OrgMember[]
  accounts    OAuthAccount[]
}

model Org {
  id                   String              @id @default(cuid())
  name                 String
  brandName            String              @default("Rivor")
  encryptedDekBlob     Bytes
  dekVersion           Int                 @default(1)
  ephemeralMode        Boolean             @default(false)
  retentionDays        Int                 @default(90)
  createdAt            DateTime            @default(now())
  updatedAt            DateTime            @updatedAt
  members              OrgMember[]
  emailAccounts        EmailAccount[]
  calendarAccounts     CalendarAccount[]
  contacts             Contact[]
  leads                Lead[]
  pipelineStages       PipelineStage[]
  threads              EmailThread[]
  messages             EmailMessage[]
  calendarEvents       CalendarEvent[]
  tasks                Task[]
  webhookSubscriptions WebhookSubscription[]
  stripeCustomers      StripeCustomer[]
  subscriptions        Subscription[]
  audits               AuditLog[]
}

model OrgMember {
  id        String   @id @default(cuid())
  org       Org      @relation(fields: [orgId], references: [id], onDelete: Cascade)
  orgId     String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String
  role      String   @default("member")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([orgId, userId])
}

model OAuthAccount {
  id            String   @id @default(cuid())
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId        String
  provider      String
  providerId    String
  accessToken   Bytes
  refreshToken  Bytes
  scope         String?
  expiresAt     DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([provider, providerId])
}

model EmailAccount {
  id          String   @id @default(cuid())
  org         Org      @relation(fields: [orgId], references: [id], onDelete: Cascade)
  orgId       String
  provider    String
  status      String   @default("connected")
  historyId   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  threads     EmailThread[]
}

model EmailThread {
  id                 String        @id @default(cuid())
  org                Org           @relation(fields: [orgId], references: [id], onDelete: Cascade)
  orgId              String
  account            EmailAccount  @relation(fields: [accountId], references: [id], onDelete: Cascade)
  accountId          String
  subjectEnc         Bytes?
  participantsEnc    Bytes?
  subjectIndex       String?       @db.Text
  participantsIndex  String?       @db.Text
  summaryEnc         Bytes?
  summaryAt          DateTime?
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt
  messages           EmailMessage[]
}

model EmailMessage {
  id                 String       @id @default(cuid())
  thread             EmailThread  @relation(fields: [threadId], references: [id], onDelete: Cascade)
  threadId           String
  org                Org          @relation(fields: [orgId], references: [id], onDelete: Cascade)
  orgId              String
  messageId          String       // External message ID from provider
  sentAt             DateTime
  fromEnc            Bytes?
  toEnc              Bytes?
  ccEnc              Bytes?
  bccEnc             Bytes?
  subjectEnc         Bytes?
  snippetEnc         Bytes?
  bodyRefEnc         Bytes?
  attachmentsMetaEnc Bytes?
  subjectIndex       String?      @db.Text
  participantsIndex  String?      @db.Text
  createdAt          DateTime     @default(now())
  updatedAt          DateTime     @updatedAt

  @@unique([orgId, messageId])
}

model CalendarAccount {
  id          String   @id @default(cuid())
  org         Org      @relation(fields: [orgId], references: [id], onDelete: Cascade)
  orgId       String
  provider    String
  status      String   @default("connected")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  events      CalendarEvent[]
}

model CalendarEvent {
  id             String          @id @default(cuid())
  org            Org             @relation(fields: [orgId], references: [id], onDelete: Cascade)
  orgId          String
  account        CalendarAccount @relation(fields: [accountId], references: [id], onDelete: Cascade)
  accountId      String
  start          DateTime
  end            DateTime
  titleEnc       Bytes?
  locationEnc    Bytes?
  notesEnc       Bytes?
  attendeesEnc   Bytes?
  titleIndex     String?         @db.Text
  locationIndex  String?         @db.Text
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
}

model Contact {
  id              String     @id @default(cuid())
  org             Org        @relation(fields: [orgId], references: [id], onDelete: Cascade)
  orgId           String
  nameEnc         Bytes?
  emailEnc        Bytes?
  phoneEnc        Bytes?
  companyEnc      Bytes?
  titleEnc        Bytes?
  addressEnc      Bytes?
  notesEnc        Bytes?
  nameIndex       String?    @db.Text
  emailIndex      String?    @db.Text
  companyIndex    String?    @db.Text
  source          String?    // email, manual, import, etc.
  tags            String[]   // Array of tag strings
  lastActivity    DateTime?
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
  leads           Lead[]

  @@unique([orgId, emailIndex])
}

model Lead {
  id                   String          @id @default(cuid())
  org                  Org             @relation(fields: [orgId], references: [id], onDelete: Cascade)
  orgId                String
  contact              Contact?        @relation(fields: [contactId], references: [id])
  contactId            String?
  stage                PipelineStage?  @relation(fields: [stageId], references: [id])
  stageId              String?
  title                String?         // Deal title/name
  dealValueEnc         Bytes?          // Deal amount
  probabilityPercent   Int?            // Win probability 0-100
  notesEnc             Bytes?
  status               String          @default("active") // active, won, lost, archived
  priority             String          @default("medium") // low, medium, high
  source               String?         // email, manual, import, etc.
  assignedToId         String?         // OrgMember ID
  sourceThreadId       String?         // Link to email thread if created from email
  expectedCloseDate    DateTime?
  actualCloseDate      DateTime?
  createdAt            DateTime        @default(now())
  updatedAt            DateTime        @updatedAt
  tasks                Task[]          @relation("LeadTasks")
}

model Task {
  id              String    @id @default(cuid())
  org             Org       @relation(fields: [orgId], references: [id], onDelete: Cascade)
  orgId           String
  title           String
  description     String?
  dueAt           DateTime?
  done            Boolean   @default(false)
  priority        String    @default("medium") // low, medium, high
  assignedToId    String?   // OrgMember ID
  linkThreadId    String?   // Link to email thread
  lead            Lead?     @relation("LeadTasks", fields: [linkLeadId], references: [id])
  linkLeadId      String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
}

model PipelineStage {
  id        String   @id @default(cuid())
  org       Org      @relation(fields: [orgId], references: [id], onDelete: Cascade)
  orgId     String
  name      String
  order     Int
  color     String?  // Hex color for UI
  leads     Lead[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([orgId, order])
}

model WebhookSubscription {
  id        String   @id @default(cuid())
  org       Org      @relation(fields: [orgId], references: [id], onDelete: Cascade)
  orgId     String
  provider  String
  secret    Bytes
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model StripeCustomer {
  id            String   @id @default(cuid())
  org           Org      @relation(fields: [orgId], references: [id], onDelete: Cascade)
  orgId         String
  customerId    String   @unique
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  subscriptions Subscription[]
}

model Subscription {
  id                String         @id @default(cuid())
  org               Org            @relation(fields: [orgId], references: [id], onDelete: Cascade)
  orgId             String
  stripe            StripeCustomer @relation(fields: [stripeCustomerId], references: [id], onDelete: Cascade)
  stripeCustomerId  String
  status            String
  priceId           String
  seats             Int            @default(1)
  trialEndsAt       DateTime?
  currentPeriodEnd  DateTime?
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
}

model AuditLog {
  id         String   @id @default(cuid())
  org        Org      @relation(fields: [orgId], references: [id], onDelete: Cascade)
  orgId      String
  actorId    String?
  action     String   // decrypt_attempt, export, retention_change, admin_action
  purpose    String?
  resource   String?
  success    Boolean
  traceId    String?
  createdAt  DateTime @default(now())
}